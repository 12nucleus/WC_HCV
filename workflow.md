# HCV Cluster Identification Workflow

The HCV cluster identification process in the `/Volumes/MacOS_Storage/Projects/HCV_pipeline` codebase is a multi-stage pipeline orchestrated by `HCV_Master_script_V0_1.py`, which leverages `HCV_combine_reads_V0_1.py` for initial read processing and `HCV_kmers_distancer_V0_1.py` for k-mer based preliminary linking. The process involves several filters and thresholds at each stage to ensure accuracy and relevance.

## I. `HCV_Master_script_V0_1.py` - The Orchestrator

This is the main script that drives the entire pipeline. It manages the flow, calls other scripts, and performs the core clustering logic based on the results from the sub-scripts.

### Key Parameters/Thresholds (set in `HCV_Master_script_V0_1.py`):

*   `--hcv_kmer_threshold` (default: 0.1): Minimum fraction of matching k-mers for a sample to be considered HCV.
*   `--kmer_overlap_threshold` (default: 0.005): Threshold for k-mer overlap ratio to trigger a "potential link" between samples. This value overrides the default in `HCV_kmers_distancer_V0_1.py`.
*   `--snp_distance_threshold` (default: 9): SNP distance threshold for confirming transmission links and forming clusters.

### Pipeline Flow:

1.  **Initialization:**
    *   Sets up directories (`Reports`, `HCV_Kmers`, `HCV_fasta`).
    *   Loads existing clusters from `Reports/clusters.txt` to enable incremental clustering and merging with previous runs.

2.  **Step 1: Combine Reads (Delegated to `HCV_combine_reads_V0_1.py`)**
    *   Iterates through raw paired-end FASTQ files for each sample.
    *   For each sample, it calls `HCV_combine_reads_V0_1.py` to process the reads.

3.  **Step 2: K-mer Distancing and Initial Linking (Delegated to `HCV_kmers_distancer_V0_1.py`)**
    *   For each sample that successfully passed Step 1:
        *   **HCV Reference K-mer Screening:** Uses the `screen_sample_hcv` function to check if the sample's k-mers (generated by `HCV_combine_reads_V0_1.py`) sufficiently overlap with known HCV 1a or 1b reference k-mers.
            *   **Filter/Threshold:** A sample is considered HCV if its k-mer overlap with either reference is `>= hcv_kmer_threshold` (default 0.1). Samples failing this check might be excluded from further analysis or flagged.
        *   **K-mer Distance Analysis:** Calls `HCV_kmers_distancer_V0_1.py` for the current sample against all other samples.
            *   **Filter/Threshold:** The output from `HCV_kmers_distancer_V0_1.py` is parsed. If the k-mer overlap ratio between two samples is `>= kmer_overlap_threshold` (default 0.005), they are considered "potential k-mer links". These links are collected in `potential_kmer_links`.

4.  **Step 2.5: SNP Distance Confirmation via Group Alignment (Core Clustering Logic)**
    *   This is the most critical step for confirming genetic relatedness and forming clusters.
    *   **Group Formation:** `find_clusters` function is used to group samples based on the `potential_kmer_links`. These groups represent sets of samples that are broadly related by k-mer similarity.
    *   **FASTA Combination & MAFFT Alignment:** For each group:
        *   Individual sample FASTA files (generated by `HCV_combine_reads_V0_1.py`) are combined.
        *   The combined FASTA is aligned using MAFFT (run via Docker) to create a multiple sequence alignment.
    *   **SNP Distance Calculation (`snp-dists`):**
        *   The `snp-dists` tool is run on the aligned FASTA to generate a SNP distance matrix (both 3-column and square formats).
        *   **Filter/Threshold:** The 3-column output is parsed. For every pair of samples, the *minimum* SNP distance between any of their sequences is determined. If this minimum distance is `<= snp_distance_threshold` (default 9), the link between these two samples is "SNP-confirmed" and added to `newly_linked_pairs_this_run`.
        *   **Shared Haplotype Percentage:** For SNP-confirmed links, the percentage of shared haplotypes (sequences with 0 SNP distance) is calculated using the square distance matrix.

5.  **Step 3: Stateful Clustering Update:**
    *   The `newly_linked_pairs_this_run` (SNP-confirmed links) are used to update the global cluster state.
    *   **Merging Clusters:** If a new SNP-confirmed link connects samples from two different existing clusters, those clusters are merged.
    *   **Adding Samples to Existing Clusters:** If a new SNP-confirmed link connects an unclustered sample to an existing cluster, the sample is added.
    *   **Forming New Clusters:** If a new SNP-confirmed link connects samples not in any existing clusters, a new cluster is formed.
        *   For new clusters, a dedicated directory (e.g., `Cluster_X/`) is created.
        *   Unaligned FASTA, aligned FASTA, and SNP distance matrices are generated within this new cluster directory.
        *   **MST Visualization:** `build_mst.py` is called to generate Minimum Spanning Tree (MST) visualizations (`_MST_full.html` and `_MST_overview.html`) for the new cluster.
            *   **Filter/Threshold:** `min_degree` for MST is 0 for the full view (all edges) and 1 for the overview (likely filtering out samples with only one connection).
    *   The updated cluster assignments are written to `Reports/clusters.txt`.

6.  **Reporting & Cleanup:**
    *   A detailed `Run_Report_YYYY-MM-DD_HH-MM-SS.txt` is generated, summarizing the pipeline's execution, including SNP-confirmed links, shared haplotype percentages, and cluster formation/merging events.
    *   Individual sample reports (`_report.out`) are also updated.
    *   Temporary directories are cleaned up unless `--keep_tmp` is specified.

---

## II. `HCV_combine_reads_V0_1.py` - Read Processing and Filtering

This script takes raw paired-end FASTQ files, processes them, and outputs filtered FASTA sequences and k-mer counts for a single sample.

### Steps, Filters, and Thresholds:

1.  **Adapter Trimming (using `cutadapt`):**
    *   Removes adapter sequences (e.g., `GGATATGATGATGAACTGGT`, `ATGTGCCAGCTGCCGTTGGTGT`) from R1 and R2 reads.

2.  **Read Merging (using `bbmerge.sh`):**
    *   Merges overlapping paired-end reads into single, longer sequences.
    *   **Filter/Threshold:** `--min_overlap` (default: 150). Reads must have at least 150 bp overlap to be merged.

3.  **Sequence Filtering:**
    *   Reads the merged sequences and applies multiple filters to identify relevant HCV haplotypes.
    *   **Filter 1: Minimum Read Count:**
        *   **Threshold:** `--min_count` (default: 10). A unique sequence (haplotype) is kept only if it is represented by at least 10 reads.
    *   **Filter 2: Minimum Length:**
        *   **Threshold:** `--min_len_merged_reads` (default: 225). A unique sequence is kept only if its length is at least 225 base pairs.
    *   **Filter 3: Minimum Reference K-mer Matches:**
        *   **Threshold:** `--min_kmer_matches` (default: 15). Each unique sequence (and its reverse complement) must contain at least 15 k-mers that match k-mers from the pre-loaded HCV 1a/1b reference sets. This ensures the sequences are genuinely HCV-related.

4.  **Sample Status Determination:**
    *   **Filter/Threshold:** `--min_final_reads` (default: 5). The total count of reads that passed all the above filters is summed. If this sum is less than 5, the sample is marked "FAIL" and its data is not used for downstream analysis. Otherwise, it's "PASS".

5.  **Output Generation (if PASS):**
    *   **FASTA Output:** Filtered sequences are written to `HCV_fasta/{prefix}.fasta.gz`.
    *   **K-mer Counting (using `jellyfish`):** K-mers are counted from the filtered FASTA sequences.
        *   **Parameter:** `--kmer_size_jf` (default: 125). K-mers of length 125 are counted.
        *   Output: `HCV_Kmers/{prefix}.kmers.gz`.

---

## III. `HCV_kmers_distancer_V0_1.py` - K-mer Overlap Calculation

This script calculates the k-mer overlap between a "query" sample and all other samples, identifying preliminary potential links.

### Steps, Filters, and Thresholds:

1.  **Load K-mers:**
    *   Loads the unique k-mers (generated by `HCV_combine_reads_V0_1.py`) for the query sample and each subject sample into separate sets.

2.  **Calculate K-mer Overlap:**
    *   Computes the intersection of the k-mer sets between the query and each subject sample to find common k-mers.

3.  **Calculate Overlap Ratio:**
    *   The overlap ratio is calculated as `(number of common k-mers) / min(total k-mers in query, total k-mers in subject)`. This normalizes the similarity by the size of the smaller k-mer set.

4.  **Apply Overlap Threshold:**
    *   **Filter/Threshold:** `--overlap_threshold` (default: 0.05 in this script, but overridden to **0.005** by `HCV_Master_script_V0_1.py`). If the calculated overlap ratio is `>= 0.005`, the pair is considered to have a "significant overlap" and is recorded as a "potential k-mer link" for further SNP-based confirmation in the master script.

5.  **Output:**
    *   A tab-separated file (`{tmp_dir}/{query_prefix}_kmer_links.tsv`) is generated, listing the k-mer overlap statistics for all comparisons.
